generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  ADMIN
  FACILITATOR
  STUDENT
}

enum CohortRole {
  FACILITATOR
  STUDENT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String
  role          UserRole
  accessCode    String?        @unique
  avatar        String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  createdCohorts    Cohort[]         @relation("CohortCreator")
  cohortMemberships CohortUser[]
  assignments       Assignment[]     @relation("AssignmentCreator")
  submissions       Submission[]
  attendances       Attendance[]
  forumPosts        ForumPost[]
  forumAnswers      ForumAnswer[]
  refreshTokens     RefreshToken[]
  points            UserPoints?
  badges            UserBadge[]
  streak            Streak?
  files             File[]
  activityLogs      ActivityLog[]
  certificates      Certificate[]
  resourceViews     ResourceView[]
  
  @@index([email])
  @@index([role])
  @@index([accessCode])
}

model Cohort {
  id                    String         @id @default(uuid())
  name                  String
  description           String
  startDate             DateTime
  endDate               DateTime
  studentInviteLink     String         @unique
  facilitatorInviteLink String         @unique
  createdById           String
  isActive              Boolean        @default(true)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  // Relations
  createdBy       User           @relation("CohortCreator", fields: [createdById], references: [id])
  members         CohortUser[]
  assignments     Assignment[]
  attendances     Attendance[]
  forumPosts      ForumPost[]
  certificates    Certificate[]
  resources       Resource[]
  
  @@index([createdById])
  @@index([studentInviteLink])
  @@index([facilitatorInviteLink])
}

model CohortUser {
  id        String      @id @default(uuid())
  cohortId  String
  userId    String
  role      CohortRole
  joinedAt  DateTime    @default(now())
  
  // Relations
  cohort    Cohort      @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([cohortId, userId])
  @@index([cohortId])
  @@index([userId])
}

model Assignment {
  id                 String           @id @default(uuid())
  title              String
  description        String
  dueDate            DateTime
  maxScore           Int              @default(100)
  status             AssignmentStatus @default(DRAFT)
  allowResubmission  Boolean          @default(false)
  cohortId           String
  createdById        String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  
  // Relations
  cohort      Cohort           @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  createdBy   User             @relation("AssignmentCreator", fields: [createdById], references: [id])
  submissions Submission[]
  
  @@index([cohortId])
  @@index([createdById])
  @@index([status])
}

model Submission {
  id           String    @id @default(uuid())
  assignmentId String
  userId       String
  githubUrl    String?
  fileUrls     String[]  @default([])
  notes        String?
  grade        Int?
  feedback     String?
  submittedAt  DateTime  @default(now())
  gradedAt     DateTime?
  
  // Relations
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([assignmentId])
  @@index([userId])
}

model Attendance {
  id        String           @id @default(uuid())
  cohortId  String
  userId    String
  date      DateTime
  status    AttendanceStatus
  notes     String?
  createdAt DateTime         @default(now())
  
  // Relations
  cohort    Cohort           @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([cohortId, userId, date])
  @@index([cohortId])
  @@index([userId])
  @@index([date])
}

model ForumPost {
  id        String        @id @default(uuid())
  title     String
  content   String
  tags      String[]      @default([])
  userId    String
  cohortId  String
  solved    Boolean       @default(false)
  views     Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  // Relations
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohort    Cohort        @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  answers   ForumAnswer[]
  
  @@index([cohortId])
  @@index([userId])
  @@index([solved])
}

model ForumAnswer {
  id           String      @id @default(uuid())
  postId       String
  userId       String
  content      String
  isCorrect    Boolean     @default(false)
  endorsements Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  // Relations
  post         ForumPost   @relation(fields: [postId], references: [id], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([postId])
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
}

// Gamification Models
model UserPoints {
  id        String   @id @default(uuid())
  userId    String   @unique
  totalPoints Int    @default(0)
  assignmentPoints Int @default(0)
  forumPoints Int    @default(0)
  attendancePoints Int @default(0)
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([totalPoints])
}

enum BadgeType {
  FIRST_ASSIGNMENT
  PERFECT_SCORE
  HELPFUL_CONTRIBUTOR
  ATTENDANCE_STREAK_5
  ATTENDANCE_STREAK_10
  ATTENDANCE_STREAK_20
  TOP_PERFORMER
  EARLY_BIRD
  FORUM_EXPERT
}

model Badge {
  id          String     @id @default(uuid())
  type        BadgeType
  name        String
  description String
  icon        String
  createdAt   DateTime   @default(now())
  
  userBadges  UserBadge[]
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@index([userId])
}

model Streak {
  id              String   @id @default(uuid())
  userId          String   @unique
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActivityDate DateTime?
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// File Management
model File {
  id          String   @id @default(uuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  uploadedBy  String
  cohortId    String?
  assignmentId String?
  createdAt   DateTime @default(now())
  
  uploader    User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)
  
  @@index([uploadedBy])
  @@index([cohortId])
  @@index([assignmentId])
}

// Analytics
model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  metadata  Json?
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// Certificates
model Certificate {
  id               String   @id @default(uuid())
  userId           String
  cohortId         String
  pdfUrl           String
  verificationCode String   @unique
  issueDate        DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohort           Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([cohortId])
  @@index([verificationCode])
}

// Resources
model Resource {
  id          String         @id @default(uuid())
  cohortId    String
  title       String
  description String?
  fileUrl     String
  fileType    String
  category    String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  cohort      Cohort         @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  views       ResourceView[]
  
  @@index([cohortId])
  @@index([category])
}

model ResourceView {
  id         String   @id @default(uuid())
  resourceId String
  userId     String
  viewedAt   DateTime @default(now())
  
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([resourceId])
  @@index([userId])
}
